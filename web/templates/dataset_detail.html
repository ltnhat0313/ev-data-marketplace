<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chi ti·∫øt Dataset - EV Data Marketplace</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <div class="app-shell">
      <header class="app-header">
        <div class="brand">
          <img src="/static/logo.svg" alt="EV Data"/>
          <div class="brand-name">EV Data Marketplace</div>
        </div>
        <div class="header-actions">
          <a href="/ui/dashboard"><button class="btn btn-secondary" type="button">Dashboard</button></a>
          <a href="/ui/search"><button class="btn btn-secondary" type="button">T√¨m ki·∫øm</button></a>
        </div>
      </header>
      <aside class="app-sidebar">
        <div class="nav-section">
          <h3>ƒêi·ªÅu h∆∞·ªõng</h3>
          <ul class="nav-list">
            <li><a href="/ui/dashboard">üè† Dashboard</a></li>
            <li><a href="/ui/search">üîé T√¨m ki·∫øm</a></li>
            <li><a href="/ui/my-datasets">üìÇ My Datasets</a></li>
            <li><a href="/ui/transactions">üí≥ L·ªãch s·ª≠ giao d·ªãch</a></li>
          </ul>
        </div>
      </aside>
      <main class="app-main">
        <div class="card">
          <div style="margin-bottom: 16px;">
            <a href="/ui/search" style="text-decoration: none; color: #0b5fff;">‚Üê Quay l·∫°i t√¨m ki·∫øm</a>
          </div>
          
          <div id="datasetLoading" style="display: none;">
            <span class="spinner"></span> ƒêang t·∫£i...
          </div>
          
          <div id="datasetContent" style="display: none;">
            <h1 class="page-title" id="datasetTitle"></h1>
            
            <div class="grid-gap" style="margin-top: 20px;">
              <div>
                <div class="form-group">
                  <label>M√¥ t·∫£</label>
                  <div id="datasetDescription" style="padding: 12px; background: #f8fafc; border-radius: 8px; min-height: 60px;"></div>
                </div>
                
                <div class="form-group">
                  <label>Th√¥ng tin</label>
                  <div style="display: grid; gap: 8px;">
                    <div style="display: flex; justify-content: space-between; padding: 8px; background: #f8fafc; border-radius: 6px;">
                      <span style="color: #64748b;">Gi√°:</span>
                      <strong id="datasetPrice" style="color: #0b5fff;"></strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px; background: #f8fafc; border-radius: 6px;">
                      <span style="color: #64748b;">Ng∆∞·ªùi cung c·∫•p:</span>
                      <strong id="datasetOwner"></strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px; background: #f8fafc; border-radius: 6px;">
                      <span style="color: #64748b;">Ng√†y t·∫°o:</span>
                      <span id="datasetDate"></span>
                    </div>
                  </div>
                </div>
              </div>
              
              <div>
                <div class="card" style="background: linear-gradient(135deg, #0b5fff 0%, #0a50db 100%); color: white; padding: 24px;">
                  <h3 style="margin-bottom: 16px; color: white;">Mua Dataset</h3>
                  <div style="font-size: 32px; font-weight: 800; margin-bottom: 20px;" id="purchasePrice"></div>
                  <button id="purchaseBtn" class="btn" style="background: white; color: #0b5fff; width: 100%; padding: 14px; font-size: 16px; font-weight: 700;">
                    üõí Mua ngay
                  </button>
                  <div id="purchaseMessage" style="margin-top: 12px; font-size: 14px; opacity: 0.9;"></div>
                </div>
              </div>
            </div>
          </div>
          
          <div id="datasetError" style="display: none; padding: 20px; text-align: center; color: #b91c1c;">
            <p>Kh√¥ng t√¨m th·∫•y dataset ho·∫∑c c√≥ l·ªói x·∫£y ra.</p>
            <a href="/ui/search" class="btn btn-primary" style="margin-top: 12px;">Quay l·∫°i t√¨m ki·∫øm</a>
          </div>
        </div>
      </main>
    </div>
    <script src="/static/app.js"></script>
    <script>
      // Load dataset detail
      async function loadDatasetDetail() {
        const urlParams = new URLSearchParams(window.location.search);
        const datasetId = urlParams.get('id');
        
        if (!datasetId) {
          document.getElementById('datasetError').style.display = 'block';
          return;
        }
        
        const loading = document.getElementById('datasetLoading');
        const content = document.getElementById('datasetContent');
        const error = document.getElementById('datasetError');
        
        loading.style.display = 'block';
        content.style.display = 'none';
        error.style.display = 'none';
        
        try {
          const res = await fetch(`/datasets/${datasetId}`);
          if (!res.ok) {
            throw new Error('Dataset kh√¥ng t·ªìn t·∫°i');
          }
          const data = await res.json();
          
          document.getElementById('datasetTitle').textContent = data.title || 'Kh√¥ng c√≥ ti√™u ƒë·ªÅ';
          document.getElementById('datasetDescription').textContent = data.description || 'Kh√¥ng c√≥ m√¥ t·∫£';
          document.getElementById('datasetPrice').textContent = `${data.price || 0} VNƒê`;
          document.getElementById('purchasePrice').textContent = `${data.price || 0} VNƒê`;
          document.getElementById('datasetOwner').textContent = data.owner_username || `ID: ${data.owner_id}`;
          document.getElementById('datasetDate').textContent = data.created_at ? new Date(data.created_at).toLocaleDateString('vi-VN') : 'N/A';
          
          window.currentDatasetId = datasetId;
          window.currentDatasetPrice = data.price || 0;
          
          loading.style.display = 'none';
          content.style.display = 'block';
        } catch (e) {
          console.error(e);
          loading.style.display = 'none';
          error.style.display = 'block';
        }
      }
      
      // Purchase button
      const purchaseBtn = document.getElementById('purchaseBtn');
      if (purchaseBtn) {
        purchaseBtn.addEventListener('click', async () => {
          const token = localStorage.getItem('token');
          if (!token) {
            alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ mua dataset');
            window.location.href = '/ui/login';
            return;
          }
          
          if (!window.currentDatasetId) {
            alert('L·ªói: Kh√¥ng t√¨m th·∫•y dataset ID');
            return;
          }
          
          purchaseBtn.disabled = true;
          purchaseBtn.textContent = 'ƒêang x·ª≠ l√Ω...';
          
          try {
            const res = await fetch(`/transactions/purchase?dataset_id=${parseInt(window.currentDatasetId)}`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`
              }
            });
            
            const data = await res.json();
            
            if (data.ok) {
              document.getElementById('purchaseMessage').textContent = '‚úÖ ' + (data.message || 'Mua th√†nh c√¥ng!');
              purchaseBtn.textContent = '‚úÖ ƒê√£ mua';
              purchaseBtn.style.background = '#059669';
              purchaseBtn.style.color = 'white';
              showToast('Mua dataset th√†nh c√¥ng!', 'success');
            } else {
              throw new Error(data.detail || 'Mua th·∫•t b·∫°i');
            }
          } catch (e) {
            alert('L·ªói: ' + e.message);
            purchaseBtn.disabled = false;
            purchaseBtn.textContent = 'üõí Mua ngay';
          }
        });
      }
      
      loadDatasetDetail();
    </script>
  </body>
</html>

