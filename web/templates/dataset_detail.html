<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chi ti·∫øt Dataset - EV Data Marketplace</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <div class="app-shell">
      <header class="app-header">
        <div class="brand">
          <img src="/static/logo.svg" alt="EV Data"/>
          <div class="brand-name">EV Data Marketplace</div>
        </div>
        <div class="header-actions">
          <a href="/ui/dashboard"><button class="btn btn-secondary" type="button">Dashboard</button></a>
          <a href="/ui/search"><button class="btn btn-secondary" type="button">T√¨m ki·∫øm</button></a>
        </div>
      </header>
      <aside class="app-sidebar">
        <div class="nav-section">
          <h3>ƒêi·ªÅu h∆∞·ªõng</h3>
          <ul class="nav-list">
            <li><a href="/ui/dashboard">üè† Dashboard</a></li>
            <li><a href="/ui/search">üîé T√¨m ki·∫øm</a></li>
            <li><a href="/ui/my-datasets">üìÇ My Datasets</a></li>
            <li><a href="/ui/transactions">üí≥ L·ªãch s·ª≠ giao d·ªãch</a></li>
          </ul>
        </div>
      </aside>
      <main class="app-main">
        <div class="card">
          <div style="margin-bottom: 16px;">
            <a href="/ui/search" style="text-decoration: none; color: #0b5fff;">‚Üê Quay l·∫°i t√¨m ki·∫øm</a>
          </div>
          
          <div id="datasetLoading" style="display: none;">
            <span class="spinner"></span> ƒêang t·∫£i...
          </div>
          
          <div id="datasetContent" style="display: none;">
            <h1 class="page-title" id="datasetTitle"></h1>
            
            <div class="grid-gap" style="margin-top: 20px;">
              <div>
                <div class="form-group">
                  <label>M√¥ t·∫£</label>
                  <div id="datasetDescription" style="padding: 12px; background: #f8fafc; border-radius: 8px; min-height: 60px;"></div>
                </div>
                
                <div class="form-group">
                  <label>Th√¥ng tin</label>
                  <div style="display: grid; gap: 8px;">
                    <div style="display: flex; justify-content: space-between; padding: 8px; background: #f8fafc; border-radius: 6px;">
                      <span style="color: #64748b;">Gi√°:</span>
                      <strong id="datasetPrice" style="color: #0b5fff;"></strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px; background: #f8fafc; border-radius: 6px;">
                      <span style="color: #64748b;">Ng∆∞·ªùi cung c·∫•p (ID):</span>
                      <strong id="datasetOwner"></strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px; background: #f8fafc; border-radius: 6px;">
                      <span style="color: #64748b;">Ng√†y t·∫°o:</span>
                      <span id="datasetDate"></span>
                    </div>
                  </div>
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label>CSV Preview (10 d√≤ng ƒë·∫ßu)</label>
                    <pre id="csvPreview" style="background: #f1f5f9; padding: 10px; border-radius: 8px; overflow-x: auto; font-size: 14px; color: #333;"></pre>
                </div>
              </div>
              
              <div>
                <div class="card" style="background: linear-gradient(135deg, #0b5fff 0%, #0a50db 100%); color: white; padding: 24px;">
                  <h3 style="margin-bottom: 16px; color: white;">Mua Dataset</h3>
                  <div style="font-size: 32px; font-weight: 800; margin-bottom: 20px;" id="purchasePrice"></div>
                  <button id="purchaseBtn" class="btn" style="background: white; color: #0b5fff; width: 100%; padding: 14px; font-size: 16px; font-weight: 700;">
                    üõí Mua ngay
                  </button>
                  <div id="purchaseMessage" style="margin-top: 12px; font-size: 14px; opacity: 0.9;"></div>
                  
                  <div id="ownerActions" style="margin-top: 20px; display: none; justify-content: space-between;">
                    <button onclick="editDataset()" class="btn btn-secondary" type="button" style="width: 48%;">S·ª≠a</button>
                    <button onclick="deleteDataset()" class="btn" type="button" style="width: 48%; background: #dc2626; color: white;">X√≥a</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div id="datasetError" style="display: none; padding: 20px; text-align: center; color: #b91c1c;">
            <p>Kh√¥ng t√¨m th·∫•y dataset ho·∫∑c c√≥ l·ªói x·∫£y ra.</p>
            <a href="/ui/search" class="btn btn-primary" style="margin-top: 12px;">Quay l·∫°i t√¨m ki·∫øm</a>
          </div>
        </div>
      </main>
    </div>
    
    <script src="/static/app.js"></script>
    <script>
      // H√†m l·∫•y datasetId t·ª´ URL (Gi·ªØ logic t·ª´ nh√°nh main/Patch 3)
      function getDatasetIdFromPath() {
        // L·∫•y ID t·ª´ path /ui/dataset/ID
        const parts = window.location.pathname.split('/');
        // ID l√† ph·∫ßn t·ª≠ cu·ªëi c√πng n·∫øu ƒë∆∞·ªùng d·∫´n l√† /ui/dataset/123
        const id = parseInt(parts[parts.length - 1]);
        return isNaN(id) ? null : id;
      }

      // Load dataset detail (H·ª£p nh·∫•t UI/UX m·ªõi v·ªõi logic backend c≈©)
      async function loadDatasetDetail() {
        const datasetId = getDatasetIdFromPath();
        const token = localStorage.getItem("token");
        const loading = document.getElementById('datasetLoading');
        const content = document.getElementById('datasetContent');
        const error = document.getElementById('datasetError');
        const ownerActions = document.getElementById('ownerActions');

        if (!datasetId) {
          error.style.display = 'block';
          return;
        }

        loading.style.display = 'block';
        content.style.display = 'none';
        error.style.display = 'none';
        
        try {
          // L·∫•y th√¥ng tin dataset
          const res = await fetch(`/datasets/${datasetId}`, {
            headers: { "Authorization": `Bearer ${token}` }
          });
          
          if (!res.ok) {
            throw new Error('Dataset kh√¥ng t·ªìn t·∫°i');
          }
          
          const data = await res.json();
          const isOwner = localStorage.getItem("user_id") == data.owner_id;
          
          document.getElementById('datasetTitle').textContent = data.title || 'Kh√¥ng c√≥ ti√™u ƒë·ªÅ';
          document.getElementById('datasetDescription').textContent = data.description || 'Kh√¥ng c√≥ m√¥ t·∫£';
          document.getElementById('datasetPrice').textContent = `${data.price || 0} VNƒê`;
          document.getElementById('purchasePrice').textContent = `${data.price || 0} VNƒê`;
          document.getElementById('datasetOwner').textContent = data.owner_username || `ID: ${data.owner_id}`;
          document.getElementById('datasetDate').textContent = data.created_at ? new Date(data.created_at).toLocaleDateString('vi-VN') : 'N/A';
          document.getElementById('csvPreview').textContent = (data.preview || []).join('\n'); // Th√™m Preview
          
          window.currentDatasetId = datasetId;
          
          // Hi·ªÉn th·ªã n√∫t Edit/Delete n·∫øu l√† Owner
          if (isOwner) {
            ownerActions.style.display = 'flex';
          } else {
            ownerActions.style.display = 'none';
          }

          loading.style.display = 'none';
          content.style.display = 'block';
        } catch (e) {
          console.error(e);
          loading.style.display = 'none';
          error.style.display = 'block';
        }
      }

      // Purchase button (Gi·ªØ logic t·ª´ ui-improvements)
      const purchaseBtn = document.getElementById('purchaseBtn');
      if (purchaseBtn) {
        purchaseBtn.addEventListener('click', async () => {
          const token = localStorage.getItem('token');
          if (!token) {
            alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ mua dataset');
            window.location.href = '/ui/login';
            return;
          }
          
          if (!window.currentDatasetId) {
            alert('L·ªói: Kh√¥ng t√¨m th·∫•y dataset ID');
            return;
          }
          
          purchaseBtn.disabled = true;
          purchaseBtn.textContent = 'ƒêang x·ª≠ l√Ω...';
          
          try {
            const res = await fetch(`/transactions/purchase?dataset_id=${parseInt(window.currentDatasetId)}`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`
              }
            });
            
            const data = await res.json();
            
            if (data.ok) {
              document.getElementById('purchaseMessage').textContent = '‚úÖ ' + (data.message || 'Mua th√†nh c√¥ng!');
              purchaseBtn.textContent = '‚úÖ ƒê√£ mua';
              purchaseBtn.style.background = '#059669';
              purchaseBtn.style.color = 'white';
              showToast('Mua dataset th√†nh c√¥ng!', 'success');
            } else {
              throw new Error(data.detail || 'Mua th·∫•t b·∫°i');
            }
          } catch (e) {
            alert('L·ªói: ' + e.message);
            purchaseBtn.disabled = false;
            purchaseBtn.textContent = 'üõí Mua ngay';
          }
        });
      }
      
      // Ch·ª©c nƒÉng Edit/Delete (L·∫•y t·ª´ nh√°nh main/Patch 3)
      function editDataset() {
        const datasetId = window.currentDatasetId;
        window.location.href = `/ui/edit-dataset/${datasetId}`; // Gi·∫£ ƒë·ªãnh c√≥ route /ui/edit-dataset
      }

      async function deleteDataset() {
        const datasetId = window.currentDatasetId;
        const token = localStorage.getItem("token");
        if (!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a?")) return;
        const res = await fetch(`/datasets/${datasetId}`, {
            method: "DELETE",
            headers: { "Authorization": `Bearer ${token}` }
        });
        if (res.ok) {
            alert("ƒê√£ x√≥a dataset");
            window.location.href = "/ui/my-datasets";
        } else {
            const data = await res.json();
            alert(data.detail || "Kh√¥ng th·ªÉ x√≥a dataset");
        }
      }

      loadDatasetDetail();
    </script>
  </body>
</html>