<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chi ti·∫øt Dataset - EV Data Marketplace</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <div class="app-shell">
      <header class="app-header">
        <div class="brand">
          <img src="/static/logo.svg" alt="EV Data"/>
          <div class="brand-name">EV Data Marketplace</div>
        </div>
        <div class="header-actions">
          <a href="/ui/dashboard"><button class="btn btn-secondary" type="button">Dashboard</button></a>
          <a href="/ui/search"><button class="btn btn-secondary" type="button">T√¨m ki·∫øm</button></a>
        </div>
      </header>
      <aside class="app-sidebar">
        <div class="nav-section">
          <h3>ƒêi·ªÅu h∆∞·ªõng</h3>
          <ul class="nav-list">
            <li><a href="/ui/dashboard">üè† Dashboard</a></li>
            <li><a href="/ui/search">üîé T√¨m ki·∫øm</a></li>
            <li><a href="/ui/my-datasets">üìÇ My Datasets</a></li>
            <li><a href="/ui/transactions">üí≥ L·ªãch s·ª≠ giao d·ªãch</a></li>
            <li><a href="/ui/profile">üë§ H·ªì s∆°</a></li>
          </ul>
        </div>
      </aside>
      <main class="app-main">
        <div class="card">
          <div style="margin-bottom: 16px;">
             <a href="#" onclick="history.back(); return false;" style="text-decoration: none; color: #0b5fff;">‚Üê Quay l·∫°i</a>
          </div>
          
          <div id="datasetLoading" style="display: none;">
            <span class="spinner"></span> ƒêang t·∫£i...
          </div>
          
          <div id="datasetContent" style="display: none;">
            <h1 class="page-title" id="datasetTitle"></h1>
            
            <div class="grid-gap" style="margin-top: 20px;">
              <div>
                <div class="form-group">
                  <label>M√¥ t·∫£</label>
                  <div id="datasetDescription" style="padding: 12px; background: #f8fafc; border-radius: 8px; min-height: 60px;"></div>
                </div>
                
                <div class="form-group">
                  <label>Th√¥ng tin c∆° b·∫£n</label>
                  <div style="display: grid; gap: 8px;">
                    <div style="display: flex; justify-content: space-between; padding: 8px; background: #f8fafc; border-radius: 6px;">
                      <span style="color: #64748b;">Gi√° b√°n:</span>
                      <strong id="datasetPrice" style="color: #0b5fff;"></strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px; background: #f8fafc; border-radius: 6px;">
                      <span style="color: #64748b;">Ng∆∞·ªùi cung c·∫•p:</span>
                      <strong id="datasetOwner"></strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px; background: #f8fafc; border-radius: 6px;">
                      <span style="color: #64748b;">Ng√†y ƒëƒÉng:</span>
                      <span id="datasetDate"></span>
                    </div>
                  </div>
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label>Xem tr∆∞·ªõc d·ªØ li·ªáu (10 d√≤ng ƒë·∫ßu)</label>
                    <pre id="csvPreview" style="background: #1e293b; color: #e2e8f0; padding: 15px; border-radius: 8px; overflow-x: auto; font-family: monospace; font-size: 13px; line-height: 1.5;"></pre>
                </div>
              </div>
              
              <div>
                <div class="card" style="background: #1e3a8a; color: white; padding: 24px;">
                  <h3 style="margin-bottom: 16px; color: white;">Mua Dataset n√†y</h3>
                  <div style="font-size: 32px; font-weight: 800; margin-bottom: 20px;" id="purchasePrice"></div>
                  
                  <button id="purchaseBtn" class="btn" style="background: rgba(255,255,255,0.1); color: white; width: 100%; padding: 14px; font-size: 16px; font-weight: 700; border: 1px solid rgba(255,255,255,0.2);">
                    B·∫°n l√† ch·ªß s·ªü h·ªØu
                  </button>
                  
                  <div id="purchaseMessage" style="margin-top: 12px; font-size: 14px; opacity: 0.9;"></div>
                  
                  <div id="ownerActions" style="margin-top: 20px; display: none; flex-direction: column; gap: 10px;">
                    <div style="font-size: 12px; opacity: 0.7; text-align: center; margin-bottom: 5px;">Qu·∫£n l√Ω (D√†nh cho ch·ªß s·ªü h·ªØu):</div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="editDataset()" class="btn btn-secondary" type="button" style="flex: 1; background: rgba(255,255,255,0.1); color: white; border: none;">‚úèÔ∏è S·ª≠a</button>
                        <button onclick="deleteDataset()" class="btn" type="button" style="flex: 1; background: #b91c1c; color: white; border: none;">üóëÔ∏è X√≥a</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div id="datasetError" style="display: none; padding: 40px; text-align: center; color: #b91c1c;">
            <p style="font-size: 18px; font-weight: 600;">Kh√¥ng t√¨m th·∫•y dataset</p>
            <p style="color: #64748b; margin-top: 8px;">Dataset n√†y c√≥ th·ªÉ ƒë√£ b·ªã x√≥a ho·∫∑c kh√¥ng t·ªìn t·∫°i.</p>
            <a href="/ui/search" class="btn btn-primary" style="margin-top: 20px; display: inline-block;">Quay l·∫°i t√¨m ki·∫øm</a>
          </div>
        </div>
      </main>
    </div>
    
    <script src="/static/app.js"></script>
    <script>
      // Bi·∫øn to√†n c·ª•c l∆∞u ID
      window.currentDatasetId = null;

      function getDatasetIdFromPath() {
        // L·∫•y ID t·ª´ URL: /ui/dataset/123 -> 123
        const parts = window.location.pathname.split('/');
        const id = parseInt(parts[parts.length - 1]);
        return isNaN(id) ? null : id;
      }

      async function loadDatasetDetail() {
        const datasetId = getDatasetIdFromPath();
        const token = localStorage.getItem("token");
        
        const loading = document.getElementById('datasetLoading');
        const content = document.getElementById('datasetContent');
        const error = document.getElementById('datasetError');
        const ownerActions = document.getElementById('ownerActions');
        const purchaseBtn = document.getElementById('purchaseBtn');

        if (!datasetId) {
          error.style.display = 'block';
          return;
        }

        window.currentDatasetId = datasetId;
        loading.style.display = 'block';
        content.style.display = 'none';
        error.style.display = 'none';
        
        try {
          // S·ª¨A: Th√™m /api v√†o ƒë∆∞·ªùng d·∫´n fetch
          const res = await fetch(`/api/datasets/${datasetId}`, {
            headers: token ? { "Authorization": `Bearer ${token}` } : {}
          });
          
          if (!res.ok) {
            throw new Error('Dataset kh√¥ng t·ªìn t·∫°i');
          }
          
          const data = await res.json();
          
          // Ki·ªÉm tra quy·ªÅn s·ªü h·ªØu (ƒë·ªÉ hi·ªán n√∫t S·ª≠a/X√≥a)
          let currentUserId = null;
          if (token) {
             try {
                 const userRes = await fetch('/api/users/me', { headers: { Authorization: `Bearer ${token}` } });
                 if (userRes.ok) {
                     const userData = await userRes.json();
                     currentUserId = userData.id;
                 }
             } catch (e) {}
          }
          
          const isOwner = currentUserId && (currentUserId === data.owner_id);
          
          document.getElementById('datasetTitle').textContent = data.title || 'Kh√¥ng c√≥ ti√™u ƒë·ªÅ';
          document.getElementById('datasetDescription').textContent = data.description || 'Kh√¥ng c√≥ m√¥ t·∫£';
          
          const priceStr = new Intl.NumberFormat('vi-VN').format(data.price || 0) + ' VNƒê';
          document.getElementById('datasetPrice').textContent = priceStr;
          document.getElementById('purchasePrice').textContent = priceStr;
          
          document.getElementById('datasetOwner').textContent = data.owner_username || `User #${data.owner_id}`;
          document.getElementById('datasetDate').textContent = data.created_at ? new Date(data.created_at).toLocaleDateString('vi-VN') : 'N/A';
          
          // Load Preview (G·ªçi API ri√™ng)
          loadPreview(datasetId);
          
          // X·ª≠ l√Ω n√∫t Mua / Action
          if (isOwner) {
            ownerActions.style.display = 'flex';
            purchaseBtn.style.display = 'none'; // ·∫®n n√∫t mua n·∫øu l√† ch·ªß
          } else {
            ownerActions.style.display = 'none';
            purchaseBtn.style.display = 'block';
            purchaseBtn.textContent = 'üõí Mua ngay';
            purchaseBtn.style.background = 'white';
            purchaseBtn.style.color = '#1e3a8a';
            purchaseBtn.onclick = buyDataset;
          }

          loading.style.display = 'none';
          content.style.display = 'block';
        } catch (e) {
          console.error(e);
          loading.style.display = 'none';
          error.style.display = 'block';
        }
      }

      async function loadPreview(id) {
          const token = localStorage.getItem("token");
          try {
              // S·ª¨A: Th√™m /api
              const res = await fetch(`/api/datasets/${id}/preview`, {
                  headers: token ? { "Authorization": `Bearer ${token}` } : {}
              });
              if(res.ok) {
                  const data = await res.json();
                  document.getElementById('csvPreview').textContent = (data.preview || []).join('\n');
              } else {
                  document.getElementById('csvPreview').textContent = "Kh√¥ng th·ªÉ t·∫£i b·∫£n xem tr∆∞·ªõc.";
              }
          } catch(e) {
              document.getElementById('csvPreview').textContent = "L·ªói t·∫£i preview.";
          }
      }

      async function buyDataset() {
          const token = localStorage.getItem('token');
          if (!token) {
            alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ mua dataset');
            window.location.href = '/ui/login';
            return;
          }
          
          const btn = document.getElementById('purchaseBtn');
          const originalText = btn.textContent;
          btn.textContent = 'ƒêang x·ª≠ l√Ω...';
          btn.disabled = true;
          
          try {
            // S·ª¨A: Th√™m /api
            const res = await fetch(`/api/transactions/purchase?dataset_id=${window.currentDatasetId}`, {
              method: 'POST',
              headers: { 'Authorization': `Bearer ${token}` }
            });
            
            const data = await res.json();
            if (data.ok) {
              document.getElementById('purchaseMessage').textContent = '‚úÖ ' + (data.message || 'Mua th√†nh c√¥ng!');
              btn.textContent = '‚úÖ ƒê√£ s·ªü h·ªØu';
              btn.style.background = '#059669';
              btn.style.color = 'white';
              btn.onclick = null;
            } else {
              throw new Error(data.detail || 'Mua th·∫•t b·∫°i');
            }
          } catch (e) {
            alert('L·ªói: ' + e.message);
            btn.textContent = originalText;
            btn.disabled = false;
          }
      }

      async function editDataset() {
        const id = window.currentDatasetId;
        const currentTitle = document.getElementById('datasetTitle').textContent;
        const currentDesc = document.getElementById('datasetDescription').textContent;
        const currentPrice = document.getElementById('datasetPrice').textContent.replace(' VNƒê', '').replace(/\./g, '');

        const newTitle = prompt("T√™n dataset m·ªõi:", currentTitle);
        if (newTitle === null) return;
        
        const newDesc = prompt("M√¥ t·∫£ m·ªõi:", currentDesc);
        const newPrice = prompt("Gi√° m·ªõi (VNƒê):", currentPrice);

        const fd = new FormData();
        fd.append('title', newTitle);
        if (newDesc !== null) fd.append('description', newDesc);
        if (newPrice !== null) fd.append('price', newPrice);

        const token = localStorage.getItem("token");
        try {
            // S·ª¨A: Th√™m /api
            const res = await fetch(`/api/datasets/${id}`, {
                method: "PUT",
                headers: { "Authorization": `Bearer ${token}` },
                body: fd
            });
            if (res.ok) {
                alert("C·∫≠p nh·∫≠t th√†nh c√¥ng!");
                loadDatasetDetail(); // Reload l·∫°i trang
            } else {
                const d = await res.json();
                alert(d.detail || "L·ªói c·∫≠p nh·∫≠t");
            }
        } catch(e) {
            alert("L·ªói k·∫øt n·ªëi server");
        }
      }

      async function deleteDataset() {
        const datasetId = window.currentDatasetId;
        const token = localStorage.getItem("token");
        if (!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a vƒ©nh vi·ªÖn dataset n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.")) return;
        
        try {
            // S·ª¨A: Th√™m /api v√†o ƒë∆∞·ªùng d·∫´n
            const res = await fetch(`/api/datasets/${datasetId}`, {
                method: "DELETE",
                headers: { "Authorization": `Bearer ${token}` }
            });
            
            if (res.ok) {
                alert("ƒê√£ x√≥a dataset th√†nh c√¥ng.");
                window.location.href = "/ui/my-datasets";
            } else {
                const data = await res.json();
                alert("L·ªói: " + (data.detail || "Kh√¥ng th·ªÉ x√≥a dataset"));
            }
        } catch (e) {
            alert("L·ªói k·∫øt n·ªëi server khi x√≥a dataset: " + e.message);
        }
      }

      // Ch·∫°y h√†m load
      loadDatasetDetail();
    </script>
  </body>
</html>