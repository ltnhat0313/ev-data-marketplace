<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - EV Data Marketplace</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <div class="app-shell">
      <header class="app-header">
        <div class="brand">
          <img src="/static/logo.svg" alt="EV Data"/>
          <div class="brand-name">EV Data Marketplace - Admin</div>
        </div>
        <div class="header-actions">
          <a href="/ui/dashboard"><button class="btn btn-secondary" type="button">Dashboard</button></a>
          <button id="logoutBtn" class="btn btn-secondary" type="button">ƒêƒÉng xu·∫•t</button>
        </div>
      </header>
      <aside class="app-sidebar">
        <div class="nav-section">
          <h3>ƒêi·ªÅu h∆∞·ªõng</h3>
          <ul class="nav-list">
            <li><a href="/ui/admin">üìä T·ªïng quan</a></li>
            <li><a href="/ui/admin?tab=users">üë• Qu·∫£n l√Ω Users</a></li>
            <li><a href="/ui/admin?tab=datasets">üìÇ Qu·∫£n l√Ω Datasets</a></li>
            <li><a href="/ui/admin?tab=transactions">üí≥ Giao d·ªãch</a></li>
          </ul>
        </div>
      </aside>
      <main class="app-main">
        <!-- Stats Overview -->
        <div class="card">
          <h1 class="page-title">üìä Admin Dashboard</h1>
          <div class="grid-3" id="adminStats">
            <div class="card grid-gap summary-card">
              <div class="stat-label">T·ªïng Users</div>
              <div class="stat-value" id="statUsers">0</div>
            </div>
            <div class="card grid-gap summary-card">
              <div class="stat-label">T·ªïng Datasets</div>
              <div class="stat-value" id="statDatasets">0</div>
            </div>
            <div class="card grid-gap summary-card">
              <div class="stat-label">T·ªïng Giao d·ªãch</div>
              <div class="stat-value" id="statTransactions">0</div>
            </div>
          </div>
          
          <div class="grid-3" style="margin-top: 16px;">
            <div class="card grid-gap summary-card">
              <div class="stat-label">Consumers</div>
              <div class="stat-value" id="statConsumers">0</div>
            </div>
            <div class="card grid-gap summary-card">
              <div class="stat-label">Providers</div>
              <div class="stat-value" id="statProviders">0</div>
            </div>
            <div class="card grid-gap summary-card">
              <div class="stat-label">T·ªïng Doanh thu</div>
              <div class="stat-value" id="statRevenue">0 VNƒê</div>
            </div>
          </div>
        </div>

        <!-- Tabs -->
        <div class="card" style="margin-top: 12px;">
          <div style="display: flex; gap: 8px; border-bottom: 2px solid #e2e8f0; margin-bottom: 16px;">
            <button class="tab-btn active" data-tab="users">üë• Users</button>
            <button class="tab-btn" data-tab="datasets">üìÇ Datasets</button>
            <button class="tab-btn" data-tab="transactions">üí≥ Transactions</button>
          </div>

          <!-- Users Tab -->
          <div id="tab-users" class="tab-content active">
            <h2 class="page-title">Qu·∫£n l√Ω Users</h2>
            <div id="usersLoading" style="display: none;"><span class="spinner"></span> ƒêang t·∫£i...</div>
            <table class="table" id="usersTable">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Username</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Thao t√°c</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div id="usersEmpty" style="display: none; text-align: center; padding: 20px; color: #64748b;">Kh√¥ng c√≥ users</div>
            <div style="display: flex; gap: 8px; margin-top: 12px;">
              <button id="usersPrev" class="btn btn-secondary">Trang tr∆∞·ªõc</button>
              <button id="usersNext" class="btn btn-secondary">Trang sau</button>
            </div>
          </div>

          <!-- Datasets Tab -->
          <div id="tab-datasets" class="tab-content" style="display: none;">
            <h2 class="page-title">Qu·∫£n l√Ω Datasets</h2>
            <div id="datasetsLoading" style="display: none;"><span class="spinner"></span> ƒêang t·∫£i...</div>
            <table class="table" id="datasetsTable">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Ti√™u ƒë·ªÅ</th>
                  <th>Owner</th>
                  <th>Gi√°</th>
                  <th>Ng√†y t·∫°o</th>
                  <th>Thao t√°c</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div id="datasetsEmpty" style="display: none; text-align: center; padding: 20px; color: #64748b;">Kh√¥ng c√≥ datasets</div>
            <div style="display: flex; gap: 8px; margin-top: 12px;">
              <button id="datasetsPrev" class="btn btn-secondary">Trang tr∆∞·ªõc</button>
              <button id="datasetsNext" class="btn btn-secondary">Trang sau</button>
            </div>
          </div>

          <!-- Transactions Tab -->
          <div id="tab-transactions" class="tab-content" style="display: none;">
            <h2 class="page-title">L·ªãch s·ª≠ Giao d·ªãch</h2>
            <div id="transactionsLoading" style="display: none;"><span class="spinner"></span> ƒêang t·∫£i...</div>
            <table class="table" id="transactionsTable">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>User</th>
                  <th>Dataset</th>
                  <th>Th·ªùi gian</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div id="transactionsEmpty" style="display: none; text-align: center; padding: 20px; color: #64748b;">Kh√¥ng c√≥ giao d·ªãch</div>
            <div style="display: flex; gap: 8px; margin-top: 12px;">
              <button id="transactionsPrev" class="btn btn-secondary">Trang tr∆∞·ªõc</button>
              <button id="transactionsNext" class="btn btn-secondary">Trang sau</button>
            </div>
          </div>
        </div>
      </main>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="/static/app.js"></script>
    <script>
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/ui/login';
      }

      let currentUsersPage = 1;
      let currentDatasetsPage = 1;
      let currentTransactionsPage = 1;

      // Load admin stats
      async function loadAdminStats() {
        try {
          const res = await fetch('/admin/stats', {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (!res.ok) {
            if (res.status === 403) {
              alert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang admin');
              window.location.href = '/ui/dashboard';
              return;
            }
            throw new Error('Kh√¥ng th·ªÉ t·∫£i stats');
          }
          const data = await res.json();
          document.getElementById('statUsers').textContent = data.users?.total || 0;
          document.getElementById('statDatasets').textContent = data.datasets || 0;
          document.getElementById('statTransactions').textContent = data.transactions || 0;
          document.getElementById('statConsumers').textContent = data.users?.consumers || 0;
          document.getElementById('statProviders').textContent = data.users?.providers || 0;
          document.getElementById('statRevenue').textContent = new Intl.NumberFormat('vi-VN').format(data.total_revenue || 0) + ' VNƒê';
        } catch (e) {
          console.error(e);
        }
      }

      // Tab switching
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const tab = btn.dataset.tab;
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => {
            c.classList.remove('active');
            c.style.display = 'none';
          });
          btn.classList.add('active');
          document.getElementById(`tab-${tab}`).classList.add('active');
          document.getElementById(`tab-${tab}`).style.display = 'block';
          
          if (tab === 'users') loadUsers();
          else if (tab === 'datasets') loadDatasets();
          else if (tab === 'transactions') loadTransactions();
        });
      });

      // Load users
      async function loadUsers(page = 1) {
        const loading = document.getElementById('usersLoading');
        const tbody = document.querySelector('#usersTable tbody');
        const empty = document.getElementById('usersEmpty');
        loading.style.display = 'block';
        tbody.innerHTML = '';
        empty.style.display = 'none';
        
        try {
          const res = await fetch(`/admin/users?page=${page}&page_size=10`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (!res.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i users');
          const data = await res.json();
          
          if (!data.items || data.items.length === 0) {
            empty.style.display = 'block';
          } else {
            tbody.innerHTML = data.items.map(u => `
              <tr>
                <td>${u.id}</td>
                <td>${u.username}</td>
                <td>${u.email}</td>
                <td><span class="badge ${u.role === 'admin' ? 'badge-warning' : u.role === 'provider' ? 'badge-info' : 'badge-success'}">${u.role}</span></td>
                <td>
                  <select class="role-select" data-user-id="${u.id}" style="padding: 4px 8px; border-radius: 4px; border: 1px solid #d1d1d1;">
                    <option value="consumer" ${u.role === 'consumer' ? 'selected' : ''}>Consumer</option>
                    <option value="provider" ${u.role === 'provider' ? 'selected' : ''}>Provider</option>
                    <option value="admin" ${u.role === 'admin' ? 'selected' : ''}>Admin</option>
                  </select>
                </td>
              </tr>
            `).join('');
            
            document.querySelectorAll('.role-select').forEach(select => {
              select.addEventListener('change', async (e) => {
                const userId = e.target.dataset.userId;
                const newRole = e.target.value;
                if (!confirm(`ƒê·ªïi role c·ªßa user #${userId} th√†nh ${newRole}?`)) {
                  e.target.value = u.role;
                  return;
                }
                try {
                  const res = await fetch(`/admin/users/${userId}/role?new_role=${newRole}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                  });
                  if (res.ok) {
                    showToast('ƒê√£ c·∫≠p nh·∫≠t role', 'success');
                    loadUsers(currentUsersPage);
                  } else {
                    throw new Error('C·∫≠p nh·∫≠t th·∫•t b·∫°i');
                  }
                } catch (e) {
                  alert('L·ªói: ' + e.message);
                }
              });
            });
          }
          currentUsersPage = page;
          loading.style.display = 'none';
        } catch (e) {
          console.error(e);
          loading.style.display = 'none';
        }
      }

      // Load datasets
      async function loadDatasets(page = 1) {
        const loading = document.getElementById('datasetsLoading');
        const tbody = document.querySelector('#datasetsTable tbody');
        const empty = document.getElementById('datasetsEmpty');
        loading.style.display = 'block';
        tbody.innerHTML = '';
        empty.style.display = 'none';
        
        try {
          const res = await fetch(`/admin/datasets?page=${page}&page_size=10`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (!res.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i datasets');
          const data = await res.json();
          
          if (!data.items || data.items.length === 0) {
            empty.style.display = 'block';
          } else {
            tbody.innerHTML = data.items.map(d => `
              <tr>
                <td>${d.id}</td>
                <td><a href="/ui/dataset?id=${d.id}" style="color: #0b5fff;">${d.title}</a></td>
                <td>${d.owner_username || d.owner_id}</td>
                <td>${new Intl.NumberFormat('vi-VN').format(d.price || 0)} VNƒê</td>
                <td>${d.created_at ? new Date(d.created_at).toLocaleDateString('vi-VN') : 'N/A'}</td>
                <td>
                  <button class="btn btn-secondary" onclick="deleteDataset(${d.id})" style="padding: 4px 8px; font-size: 12px;">X√≥a</button>
                </td>
              </tr>
            `).join('');
          }
          currentDatasetsPage = page;
          loading.style.display = 'none';
        } catch (e) {
          console.error(e);
          loading.style.display = 'none';
        }
      }

      // Load transactions
      async function loadTransactions(page = 1) {
        const loading = document.getElementById('transactionsLoading');
        const tbody = document.querySelector('#transactionsTable tbody');
        const empty = document.getElementById('transactionsEmpty');
        loading.style.display = 'block';
        tbody.innerHTML = '';
        empty.style.display = 'none';
        
        try {
          const res = await fetch(`/admin/transactions?page=${page}&page_size=10`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (!res.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i transactions');
          const data = await res.json();
          
          if (!data.items || data.items.length === 0) {
            empty.style.display = 'block';
          } else {
            tbody.innerHTML = data.items.map(tx => `
              <tr>
                <td>${tx.id}</td>
                <td>${tx.user_email || tx.user_id}</td>
                <td><a href="/ui/dataset?id=${tx.dataset_id}" style="color: #0b5fff;">${tx.dataset_title || tx.dataset_id}</a></td>
                <td>${tx.timestamp ? new Date(tx.timestamp).toLocaleString('vi-VN') : 'N/A'}</td>
              </tr>
            `).join('');
          }
          currentTransactionsPage = page;
          loading.style.display = 'none';
        } catch (e) {
          console.error(e);
          loading.style.display = 'none';
        }
      }

      // Delete dataset
      window.deleteDataset = async function(id) {
        if (!confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a dataset n√†y?')) return;
        try {
          const res = await fetch(`/admin/datasets/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (res.ok) {
            showToast('ƒê√£ x√≥a dataset', 'success');
            loadDatasets(currentDatasetsPage);
          } else {
            throw new Error('X√≥a th·∫•t b·∫°i');
          }
        } catch (e) {
          alert('L·ªói: ' + e.message);
        }
      };

      // Pagination
      document.getElementById('usersPrev')?.addEventListener('click', () => {
        if (currentUsersPage > 1) loadUsers(currentUsersPage - 1);
      });
      document.getElementById('usersNext')?.addEventListener('click', () => {
        loadUsers(currentUsersPage + 1);
      });
      document.getElementById('datasetsPrev')?.addEventListener('click', () => {
        if (currentDatasetsPage > 1) loadDatasets(currentDatasetsPage - 1);
      });
      document.getElementById('datasetsNext')?.addEventListener('click', () => {
        loadDatasets(currentDatasetsPage + 1);
      });
      document.getElementById('transactionsPrev')?.addEventListener('click', () => {
        if (currentTransactionsPage > 1) loadTransactions(currentTransactionsPage - 1);
      });
      document.getElementById('transactionsNext')?.addEventListener('click', () => {
        loadTransactions(currentTransactionsPage + 1);
      });

      // Check URL tab parameter
      const urlParams = new URLSearchParams(window.location.search);
      const tab = urlParams.get('tab');
      if (tab) {
        document.querySelector(`[data-tab="${tab}"]`)?.click();
      } else {
        loadAdminStats();
        loadUsers();
      }
    </script>
    <style>
      .tab-btn {
        padding: 10px 16px;
        border: none;
        background: transparent;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
        transition: all 0.2s;
      }
      .tab-btn:hover {
        background: #f8fafc;
      }
      .tab-btn.active {
        border-bottom-color: #0b5fff;
        color: #0b5fff;
        font-weight: 600;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
    </style>
  </body>
</html>

